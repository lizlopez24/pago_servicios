<h2 class="title">Pago de Servicios</h2>
<div class="card">
  <h3 class="subtitle">Validar cédula</h3>

  <form [formGroup]="cedulaForm" (ngSubmit)="validarCedula()" class="form">
    <div class="form-grid one-col">
      <div class="field">
        <label for="cedula">Cédula</label>
        <input id="cedula" type="text" formControlName="cedula" placeholder="Ej: 1728596421" />
        <div class="hint error" *ngIf="cedulaForm.get('cedula')?.touched && cedulaForm.get('cedula')?.invalid">
          {{ cedulaForm.get('cedula')?.errors?.['required'] ? 'La cédula es obligatoria.' : '' }}
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="submit" [disabled]="cedulaForm.invalid || isValidatingCedula">
        {{ isValidatingCedula ? 'Validando…' : 'Validar' }}
      </button>
    </div>

    <div class="alert success" *ngIf="usuario">
      <strong>¡Exitoso!</strong> Se ha validado el usuario.
    </div>

    <div class="inline-status error" *ngIf="errorMsg && !usuario">{{ errorMsg }}</div>
  </form>
</div>

<div class="card" *ngIf="usuario">
  <h3 class="subtitle">Consulta de Contrato</h3>

  <form [formGroup]="consulForm" (ngSubmit)="consultar()" class="form">
    <div class="form-grid">
      <div class="field">
        <label for="servicios">Servicio</label>
        <select id="servicios" formControlName="servicioId">
          <option value="">Selecciona un servicio</option>
          <option *ngFor="let t of tipos" [value]="t.id">{{ t.nombre }}</option>
        </select>
        <div class="hint error" *ngIf="consulForm.get('servicioId')?.touched && consulForm.get('servicioId')?.invalid">
          Selecciona un servicio válido.
        </div>
      </div>

      <div class="field">
        <label for="numero">N° de Contrato</label>
        <input id="numero" type="text" formControlName="numeroContrato" placeholder="Cuenta contrato" />
        <div class="hint error" *ngIf="consulForm.get('numeroContrato')?.touched && consulForm.get('numeroContrato')?.invalid">
          El número de contrato es obligatorio.
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="submit" [disabled]="consulForm.invalid || isLoading">
        {{ isLoading ? 'Consultando…' : 'Consultar' }}
      </button>
    </div>

    <div class="inline-status" *ngIf="isLoading">
      <span class="spinner"></span> Consultando información…
    </div>
    <div class="inline-status error" *ngIf="errorMsg">{{ errorMsg }}</div>
  </form>
</div>

<div class="result-card" *ngIf="pago">
  <div class="result-header">
    <h3>Información del Pago</h3>
    <span class="badge" [class.badge-ok]="pago.valorPagar" [class.badge-warn]="pago.valorPagar === 0">
      Estado: {{ pago.valorPagar > 0 ? 'Pendiente' : 'Sin deuda' }}
    </span>
  </div>

  <div class="result-grid">
    <div class="result-item"><div class="label">N° de contrato:</div><div class="value">{{ pago.numeroContrato }}</div></div>
    <div class="result-item"><div class="label">Descripción:</div><div class="value">{{ pago.descripcion }}</div></div>
    <div class="result-item"><div class="label">Fecha de vencimiento:</div>
      <div class="value">{{ pago.fechaVencimiento | date:'mediumDate' }}</div></div>
    <div class="result-item"><div class="label">Valor a pagar:</div>
      <div class="value strong">{{ pago.valorPagar | currency:'USD':'symbol':'1.2-2' }}</div></div>
  </div>

  <div class="result-actions">
    <button type="button" class="secondary" (click)="limpiar()">Nueva consulta</button>
    <button type="button" class="primary"
            [disabled]="pago.valorPagar === 0 || isPaying"
            (click)="pagar()">
      {{ isPaying ? 'Procesando pago…' : 'Pagar ahora' }}
    </button>
  </div>

  <div class="inline-status" *ngIf="isPaying">
    <span class="spinner"></span> Registrando pago…
  </div>
</div>

<div class="dialog-backdrop" *ngIf="showReceipt" (click)="cerrarRecibo()"></div>
<div class="dialog" *ngIf="showReceipt" role="dialog" aria-modal="true" aria-labelledby="reciboTitle">
  <div class="dialog-header">
    <h3 id="reciboTitle">Recibo de pago</h3>
    <button type="button" class="icon-close" (click)="cerrarRecibo()" aria-label="Cerrar">×</button>
  </div>

  <div class="dialog-body" *ngIf="receipt">
    <div class="grid">
      <div><strong>Cliente</strong><div>{{ receipt.clienteNombre }}</div></div>
      <div><strong>Servicio</strong><div>{{ receipt.servicioNombre }}</div></div>
      <div><strong>N° contrato</strong><div>{{ receipt.numeroContrato }}</div></div>
      <div><strong>Valor pagado</strong><div>{{ receipt.valorPagado | currency:'USD':'symbol':'1.2-2' }}</div></div>
      <div><strong>Fecha vencimiento</strong><div>{{ receipt.fechaVencimiento | date:'mediumDate' }}</div></div>
      <div><strong>Fecha de pago</strong><div>{{ receipt.fechaPago | date:'medium' }}</div></div>
      <div class="wide"><strong>Descripción</strong><div>{{ receipt.descripcion }}</div></div>
      <div class="wide info"><strong>Saldo actual del cliente</strong>
        <div class="saldo">{{ receipt.saldoActual | currency:'USD':'symbol':'1.2-2' }}</div>
      </div>
    </div>
  </div>

  <div class="dialog-actions">
    <button type="button" class="primary" (click)="cerrarRecibo()">Aceptar</button>
  </div>
</div>
